# How Reflections Work in PMM

**Date**: 2025-10-02  
**Context**: Understanding reflections vs commitments after Priority 1 fix

---

## Executive Summary

**You are correct** - reflections ARE meant to help PMM grow its understanding. They are **NOT** meant to be extracted as commitments. The bug we just fixed was preventing the system from working as designed.

### The Intended Flow

```
Reflection â†’ Analysis â†’ Action Extraction â†’ Policy/Commitment Updates
```

**NOT**: Reflection text itself becoming a commitment âŒ

---

## What Reflections Are

### Purpose
Reflections are **periodic self-assessments** where the PMM:
1. Observes its current state (IAS, GAS, traits, stage)
2. Analyzes recent changes in the ledger
3. Proposes concrete system-level actions
4. Drives autonomous growth and adaptation

### When They Happen

**Triggers** (via `AutonomyLoop` every 10-60 seconds):
- Minimum turns elapsed (default: 2)
- Minimum time elapsed (default: 60 seconds)
- Novelty threshold met (policy-driven, default: 0.2)

If any gate fails â†’ `reflection_skipped` event with reason

### What They Contain

Reflections are **analytical text** generated by the LLM containing:

**Stage-specific templates**:
- **S0 (succinct)**: Current metrics + one concrete action
- **S1 (question)**: 2 questions about ledger integrity + actionable improvement
- **S2 (narrative)**: Summary of trait/commitment changes + system adjustment
- **S3 (checklist)**: 3-item checklist (IAS/GAS changes, policy needs, immediate action)
- **S4 (analytical)**: Full analysis (observe â†’ diagnose â†’ propose intervention)

---

## The Reflection Pipeline

### 1. Generation (`emit_reflection`)
- Compute telemetry (IAS, GAS, stage, traits)
- Select stage-appropriate template
- Call LLM with context
- Append `reflection` event with full text

### 2. Validation (`_append_reflection_check`)
- Check if reflection text is non-empty
- Append `reflection_check` event with ok status

### 3. Action Extraction
- Parse reflection text for actionable insights
- Append `reflection_action` event

### 4. Policy Application
- Consume `reflection_action` text
- Emit `policy_update` events

### 5. Commitment Extraction (SEPARATE, FILTERED)
- Filter out reflection markers (IAS=, GAS=, Event ID, etc.) âœ…
- Enforce length limit (â‰¤400 chars) âœ…
- Only extract SHORT, ACTIONABLE statements

---

## The Bug We Fixed

### Before Fix
```
[3298] reflection (1895 chars)
  "Event ID 001, CID abcdef... IAS is already at maximum..."
  
â†“ _extract_commitments_from_text() â†“

[3300] commitment_open (same 1895 chars!)
  ENTIRE REFLECTION COPIED AS COMMITMENT âŒ
```

### After Fix
```
[3298] reflection (1895 chars)
  "Event ID 001, CID abcdef... IAS is already at maximum..."
  
â†“ Filters applied â†“
  - Contains "IAS=" â†’ SKIP âœ…
  - Length > 400 chars â†’ SKIP âœ…

[NO commitment_open created from reflection text]

[3301] reflection_action
  "Adjust novelty threshold to 0.45"
  
[3302] policy_update
  {"novelty_threshold": 0.45}
```

---

## How Reflections Drive Growth

### 1. Trait Evolution
```
Reflection: "Openness (O) is at 0.68..."
â†’ reflection_action: "Increase openness by 0.02"
â†’ trait_update: {"openness": +0.02}
```

### 2. Stage Progression
```
Reflection: "IAS is 0.510, below S1 threshold..."
â†’ Identifies gap
â†’ Proposes interventions to raise IAS
```

### 3. Policy Adaptation
```
Reflection: "Novelty threshold at 0.55 may limit exploration..."
â†’ reflection_action: "Lower novelty threshold to 0.45"
â†’ policy_update: {"novelty_threshold": 0.45}
```

### 4. Commitment Management
```
Reflection: "Low-priority tasks consuming resources..."
â†’ reflection_action: "Close low-priority commitments"
â†’ commitment_close events
```

---

## Reflection vs Commitment

| Aspect | Reflection | Commitment |
|--------|-----------|------------|
| **Purpose** | Self-assessment & analysis | Actionable promise/task |
| **Length** | 200-2000 characters | â‰¤400 characters |
| **Content** | Metrics, analysis, proposals | Specific action statement |
| **Frequency** | Every 10-60 seconds (gated) | As needed |
| **Source** | Autonomy loop | User/assistant conversation |
| **Event type** | `reflection` | `commitment_open` |
| **Contains** | IAS, GAS, traits, "why-mechanics" | "I will...", "Plan to..." |

---

## Summary: You Were Right!

### Your Understanding âœ…

> "Reflections should be used by the PMM as a means of growing its understanding"

**Correct!** Reflections are:
- Self-assessment observations
- Analytical thinking about current state
- Proposals for system improvements
- Drivers of autonomous growth

### The Bug We Fixed âœ…

The entire reflection text was being extracted as a commitment, which:
- Polluted the commitment ledger
- Made commitments unactionable
- Broke commitment tracking
- Prevented the system from working as designed

### How It Works Now âœ…

1. **Reflections** = Long analytical text with metrics and proposals
2. **Actions** = Extracted from reflections (short, specific)
3. **Policies** = Updated based on actions
4. **Commitments** = Separate, filtered, short, actionable statements

**The system is now functioning as you designed it!** ðŸŽ‰
